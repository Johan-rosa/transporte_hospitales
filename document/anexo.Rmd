---
output: word_document
---

```{r}
#' Get Distance and Travel Time Between Two Locations
#'
#' Queries the Google Distance Matrix API to retrieve the distance and estimated travel time
#' between an origin and a destination. Also retrieves the polyline for the route.
#'
#' @param origen A character string specifying the starting location (address or coordinates).
#' @param destino A character string specifying the destination location (address or coordinates).
#' @param key A character string with your Google Maps API key. Defaults to `Sys.getenv("API_KEY")`.
#' @param time Optional. The departure time to use for the request (either as a POSIXct object or a timestamp).
#' @param sleep Numeric. Number of seconds to wait after making the API call. Default is `2`.
#' @param mode Character. Mode of transportation to use. Options include `"driving"`, `"walking"`, `"bicycling"`, and `"transit"`. Default is `"driving"`.
#' @param ... Additional arguments passed to `googleway::google_distance()`.
#'
#' @return A `tibble` containing:
#' - `origin_address`: Resolved origin address.
#' - `destination_address`: Resolved destination address.
#' - `polyline`: Encoded polyline representing the route.
#' - `distance_value`: Distance in meters.
#' - `distance_text`: Human-readable distance.
#' - `duration_value`: Duration in seconds.
#' - `duration_text`: Human-readable duration.
#'
#' @details
#' - The function uses `googleway::google_distance()` to obtain distance and duration data, 
#'   and `googleway::google_directions()` to retrieve the polyline.
#' - The result is printed as a JSON string and returned as a tibble.
#' - A sleep is enforced after the API call to respect API usage limits.
#'
get_distance_time <- function(
    origen,
    destino,
    key = Sys.getenv("API_KEY"),
    time = NULL,
    sleep = 2,
    mode = "driving",
    ...
) {
  query_result <- googleway::google_distance(
    origins = origen,
    destinations = destino,
    key = key,
    mode = mode,
    departure_time = time,
    ...
  )
  
  result <- query_result$rows$elements |> as.data.frame()
  
  rsult_data <- tibble::tibble(
    distance_value = result$distance$value,
    distance_text = result$distance$text,
    duration_value = result$duration$value,
    duration_text = result$duration$text
  )
  
  polyline <- googleway::google_directions(origen, destino, key = key) |> 
    googleway::direction_polyline()
  
  output <- tibble::tibble(
    origin_address = query_result$origin_addresses,
    destination_address = query_result$destination_addresses,
    polyline = polyline
  ) |> 
    dplyr::bind_cols(rsult_data)
  
  Sys.sleep(sleep)
  print(jsonlite::toJSON(output))
  output
}

```

